@page "/popular-games"

@using FreeToGameExplorer.Models
@using FreeToGameExplorer.Services
@inject IGameApiClient GameApiClient

<h1>Top 5 Popular Games</h1>
<p>According to FreeToGame API <em> popularity </em> ranking.</p>
<p>For more accurate result visit Steam or other game platforms.</p>

@if (isLoading)
{
    <p>Loading top games...</p>
}
else if (!string.IsNullOrEmpty(errorMessage))
{
    <p style="color:red">@errorMessage</p>
}
else if (topGames.Count == 0)
{
    <p>No games available.</p>
}
else
{
    <div style="display:flex; flex-wrap:wrap; gap:20px;">
        @foreach (var g in topGames)
        {
            <div style="width:260px; border:1px solid #ccc; padding:10px;">
                <img src="@g.Thumbnail"
                     alt="@g.Title"
                     style="width:100%; height:140px; object-fit:cover;" />

                <h4 style="margin-top:10px;">@g.Title</h4>

                <p style="margin:0; font-size:0.9rem;">
                    <strong>Genre:</strong> @g.Genre
                </p>

                <p style="margin:0; font-size:0.9rem;">
                    <strong>Platform:</strong> @g.Platform
                </p>

                @if (!string.IsNullOrWhiteSpace(g.ReleaseDate))
                {
                    <p style="margin:0; font-size:0.9rem;">
                        <strong>Release:</strong> @g.ReleaseDate
                    </p>
                }

                <p style="margin-top:5px;">
                    <NavLink href="@($"/game/{g.Id}")">
                        View details
                    </NavLink>
                </p>
            </div>
        }
    </div>
}

@code {
    private bool isLoading = true;
    private string? errorMessage;
    private List<GameSummary> topGames = new();

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;
        errorMessage = null;

        try
        {
            // Ask the API for games sorted by popularity
            var allGames = await GameApiClient.GetGamesAsync(
                titleFilter: null,
                genre: null,
                platform: null,
                sortBy: "popularity");

            // Take top 5 most popular games
            topGames = allGames
                .Take(5)
                .ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex);
            errorMessage = "Could not load top games.";
        }
        finally
        {
            isLoading = false;
        }
    }
}
